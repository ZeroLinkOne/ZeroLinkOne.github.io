---
layout: post
comments: true
categories: 学习笔记
---

### 背景

最近用了挺多 PY32F002AL15S6TU 单片机，该芯片与 Air001 的编译方式完全兼容，可直接在 Arduino IDE 中完成编译。

但受限于 SOP8 封装的引脚数量，该芯片未配备硬件串口，程序下载仅能通过 DAPLINK 方式实现；

常规操作流程为：先导出二进制文件，再通过第三方工具 DAPLinkUtility 完成烧录，步骤相对繁琐。

查阅 DAPLinkUtility 作者主页（https://gitee.com/jhembed/projects）时，发现其提供了命令行版本的 daplink_cli 工具，因此萌生了为 Arduino IDE 扩展 DAPLINK 直接下载功能的想法，以此简化 PY32F002AL15S6TU/Air001 单片机的程序烧录流程。

### 准备 Arduino 开发板索引包
* Air001 开发板对应的 Arduino 索引包下载地址为：https://arduino.luatos.com/package_air_cn_index.json(该地址目前可能已无法正常下载)。

* 若上述地址无法下载，可选用社区版本的 Py32Duino 索引包，下载地址为：https://github.com/PY32Duino/Arduino-pack-json-ci/releases/download/Nightly/package_py32_index.json。

* 官方版本的 Air001 索引包与社区版本的 Py32Duino 索引包均由开发者 “半糖” 维护；我个人此前已提前下载好 Air001 的索引包，因此本次实操将基于该版本进行修改。

### 准备 DAPLINK 烧录工具
* DAPLINK 命令行烧录工具使用的是由开发者 “觉皇” 开发的 daplink_cli.exe，下载地址为：https://gitee.com/jhembed/daplink_cli。

* 烧录 Air001 需用到包含下载算法的 FLM 文件，获取方式有两种：
  1. 访问 Keil 官方下载站（https://www.keil.com/dd2/pack/），搜索厂商 “Puya Semiconductor”，下载 PY32F030 对应的 pack 包，用解压工具打开后，提取其中的 PY061xx_32.FLM 文件；
  2. 访问普冉（Puya）官方网站（https://www.puyasemi.com/gongjuyuruanjian.html）下载对应 pack 包，该渠道的版本会更新一些。
   
* 按以下路径新建文件夹Arduino15\packages\AirM2M\tools\DapLink\1.4.0；将下载好的 daplink-v1.4.exe 和 PY061xx_32.FLM 两个文件复制到上述新建的 1.4.0 文件夹下。

### 为 Arduino IDE 新增 DAPLINK 下载方式
* 在Arduino15\packages\AirM2M\hardware\AirMCU\0.6.4路径下,找到开发板的board.txt文件,更改如下

        # 注释原有 AirISP 默认配置
        #Air001Dev.upload.tool=AirISP
        #Air001Dev.upload.tool.default=AirISP

        # 新增上传方式选择项
        Air001Dev.menu.upload_method.AirISP=AirISP
        Air001Dev.menu.upload_method.AirISP.upload.tool=AirISP

        Air001Dev.menu.upload_method.DapLink=DapLink
        Air001Dev.menu.upload_method.DapLink.upload.tool=DapLink

* 在同路径下找到 platform.txt 文件，新增如下 DAPLINK 相关配置：

        ## DAPLINK
        ##
        tools.DapLink.path={runtime.tools.DapLink.path}
        tools.DapLink.cmd=daplink-v1.4
        tools.DapLink.cmd.windows=daplink-v1.4.exe

        ## Upload Sketch
        ## -------------
        tools.DapLink.upload.protocol=swd
        tools.DapLink.upload.params.verbose=
        tools.DapLink.upload.params.quiet=
        tools.DapLink.upload.pattern_args=flash --rambase 20000000 --ramsize 5000 --flm "{path}/PY061xx_32.FLM" --verify --file "{build.path}/{build.project_name}.bin" --addr 08000000 --fullerase 
        tools.DapLink.upload.pattern="{path}/{cmd}" {upload.pattern_args}

* 打开 Arduino IDE，选择 Air001 开发板，将下载模式切换为 DAPLINK，点击下载按钮后，程序成功烧录。
 
   ![下载成功](https://github.com/ZeroLinkOne/ZeroLinkOne.github.io/blob/master/images/daplink_cli.png?raw=true)

* Tips：若 Arduino IDE 中未出现下载方式选项，可尝试删除 C:\Users\用户\AppData\Roaming\arduino-ide 文件夹后重启。